<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ë°ì´í„° ì—…ë¡œë“œ & ë‹¤ìš´ë¡œë“œ</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 min-h-screen p-8">
  <div class="max-w-5xl mx-auto bg-white p-8 rounded-2xl shadow-xl space-y-12">
    <div class="flex justify-end mb-4">
      <button id="logoutBtn" class="bg-red-500 text-white px-4 py-2 rounded">
        ë¡œê·¸ì•„ì›ƒ
      </button>
      <button id="deleteBtn" class="bg-gray-700 text-white px-4 py-2 rounded">
	ê³„ì • ì‚­ì œ
      </button>
    </div>
    <!-- ì—…ë¡œë“œ ì˜ì—­ -->
    <section>
      <h2 class="text-2xl font-bold text-blue-700 mb-4">ğŸ“„ ë°ì´í„° ì—…ë¡œë“œ</h2>
      <form id="uploadForm" class="space-y-4" enctype="multipart/form-data">
        <input type="file" name="file" id="fileInput" class="w-full border px-4 py-2 rounded" multiple required>
        <textarea id="descInput" name="description" rows="3" class="w-full border px-4 py-2 rounded" placeholder="ê³µí†µ ì„¤ëª… (ì„ íƒ)"></textarea>
	<div id="tagSection" class="hidden">
	  <p class="mt-2 text-sm text-gray-600">ì¶”ì²œ íƒœê·¸ë¥¼ ì„ íƒí•˜ì„¸ìš”:</p>
	  <div id="tagList" class="flex flex-wrap gap-2 mt-1"></div>
	</div>
	<button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">ì—…ë¡œë“œí•˜ê¸°</button>
      </form>

      <div id="uploadMessage" class="mt-4 text-green-700 font-medium"></div>

      <!-- ê²€ìƒ‰, ì •ë ¬, í•„í„° ë©”ë‰´ -->
      <form id="searchForm" class="flex flex-nowrap gap-x-2 items-center w-full overflow-x-auto">
        <input type="text" name="word" id="searchInput" placeholder="íŒŒì¼ëª… ë˜ëŠ” ì œëª©ìœ¼ë¡œ ê²€ìƒ‰..." 
           class="border px-3 py-2 rounded flex-grow min-w-0">

        <select id="sortSelect" class="border px-3 py-2 rounded">
          <option value="name">íŒŒì¼ëª…ìˆœ</option>
          <option value="recent">ìµœì‹ ìˆœ</option>
        </select>

        <select id="dateFilter" class="border px-3 py-2 rounded">
          <option value="all">ëª¨ë“  ë‚ ì§œ</option>
          <option value="today">ì˜¤ëŠ˜</option>
          <option value="week">ì´ë²ˆ ì£¼</option>
        </select>

        <select id="typeFilter" class="border px-3 py-2 rounded">
          <option value="all">ì „ì²´</option>
          <option value="text">í…ìŠ¤íŠ¸</option>
          <option value="video">ë¹„ë””ì˜¤</option>
          <option value="audio">ì˜¤ë””ì˜¤</option>
          <option value="image">ì´ë¯¸ì§€</option>
          <option value="excel">ì—‘ì…€</option>
        </select>

        <button type="submit"
                class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded shadow whitespace-nowrap">
          ğŸ” ê²€ìƒ‰
        </button>
      </form>
      <h3 class="text-lg font-semibold text-gray-600 mb-2">ğŸ”— ì—°ê´€ ë‹¨ì–´</h3>
      <div id="relatedWordList" class="flex flex-wrap gap-2 mt-1"></div>
    </section>
    <section>
      <h2 class="text-2xl font-bold text-green-700 mb-4">ğŸ“ ê¸°ì¡´ ë°ì´í„° ë‹¤ìš´ë¡œë“œ</h2>
      <div id="downloadList" class="space-y-4"></div>
    </section>
  </div>

  <script>
    const uploadForm = document.getElementById('uploadForm');
    const fileInput = document.getElementById('fileInput');
    const descInput = document.getElementById('descInput');
    const downloadList = document.getElementById('downloadList');
    const searchForm = document.getElementById('searchForm');
    const searchInput = document.getElementById('searchInput');
    const sortSelect = document.getElementById('sortSelect');
    const dateFilter = document.getElementById('dateFilter');
    const typeFilter = document.getElementById('typeFilter');
    const uploadMessage = document.getElementById('uploadMessage');
    const pagination = document.getElementById('pagination');
    const logoutBtn = document.getElementById('logoutBtn');
    const deleteBtn = document.getElementById('deleteBtn');

    let relatedWord = [];
    let uploadedItems = [];
    let currentPage = 1;
    const itemsPerPage = 6;

    deleteBtn.addEventListener('click', async () => {
      const confirmDelete = confirm("ì •ë§ë¡œ ê³„ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!");
      if (!confirmDelete) return;

      const res = await fetch('/api/delete_account', {
        method: 'DELETE',
        credentials: 'include'  // ì¿ í‚¤ í¬í•¨
      });

      if (res.ok) {
        alert("ê³„ì •ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
        window.location.reload();  // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë””ë ‰íŠ¸
      } else {
        const data = await res.json();
        alert(data.message || 'ê³„ì • ì‚­ì œ ì‹¤íŒ¨');
      }
    });

    logoutBtn.addEventListener('click', async () => {
      const res = await fetch('/api/logout', {
        method: 'POST',
        credentials: 'include'
      });

      if (res.ok) {
        alert('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤!');
        window.location.reload();
      } else {
        alert('ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨');
      }
    });

    descInput.addEventListener('blur', () => {
      const desc = descInput.value.trim();
      if (!desc) return;

      fetch("/make_tags", {
        method: "POST",
	credentials: "include",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
        },
        body: new URLSearchParams({ description: desc })
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === "success") {
          const tagSection = document.getElementById("tagSection");
          const tagList = document.getElementById("tagList");
          tagList.innerHTML = "";
          tagSection.classList.remove("hidden");

          data.tags.forEach(tag => {
            const btn = document.createElement("button");
            btn.type = "button";
            btn.textContent = tag;
            btn.className = "px-2 py-1 rounded border bg-gray-100 hover:bg-blue-200";
            btn.dataset.selected = "false";

            btn.addEventListener("click", () => {
              const isSelected = btn.dataset.selected === "true";
              btn.dataset.selected = (!isSelected).toString();
              btn.classList.toggle("bg-blue-500", !isSelected);
              btn.classList.toggle("text-white", !isSelected);
            });

            tagList.appendChild(btn);
          });
        }
      });
    });

    uploadForm.addEventListener('submit', function (e) {
      e.preventDefault();

      const files = Array.from(fileInput.files);
      const desc = descInput.value;
      const formData = new FormData();

      files.forEach(file => {
        formData.append("file", file);
      });
      formData.append("description", desc);

      // ì„ íƒëœ íƒœê·¸ë“¤ ì¶”ì¶œ
      const selectedTags = Array.from(document.querySelectorAll('#tagList button'))
        .filter(btn => btn.dataset.selected === "true")
        .map(btn => btn.textContent);

      // íƒœê·¸ë“¤ì„ ë¬¸ìì—´ë¡œ ì„œë²„ì— ì „ì†¡
      formData.append("tags", selectedTags.join(","));

      fetch("/upload", {
        method: "POST",
	credentials: "include",
        body: formData
      })
      .then(res => res.json())
      .then(data => {
        uploadMessage.textContent = `${data.files.length}ê°œì˜ íŒŒì¼ì´ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.`;
        setTimeout(() => { uploadMessage.textContent = ''; }, 4000);
        uploadForm.reset();
        document.getElementById("tagList").innerHTML = "";
        document.getElementById("tagSection").classList.add("hidden");
      });
    });

    searchForm.addEventListener('submit', function (e) {
      e.preventDefault();
      currentPage = 1;
      fetchAndRenderFiles();
    });

    function fetchAndRenderFiles() {
	fetch(`/search?word=${encodeURIComponent(searchInput.value)}&order=${sortSelect.value}&date=${dateFilter.value}&exp=${typeFilter.value}`, {
	  credentials: "include",
	})
        .then(res => res.json())
        .then(data => {
	  relatedWord = data.related_word
          uploadedItems = data.results.map(item => ({
            title: item.file_name,
	    path: item.real_path,
            desc: '',
            time: Date.now(),
          }));
	  renderRelatedWord();
          renderDownloadList();
        });
    }

    function renderRelatedWord() {
      const container = document.getElementById("relatedWordList");
      container.innerHTML = '';

      relatedWord.forEach(word => {
        const span = document.createElement("span");
        span.textContent = word;
        span.className = "px-2 py-1 rounded border bg-gray-100 text-sm text-gray-700";
        container.appendChild(span);
      });
    }

    function renderDownloadList() {
      downloadList.innerHTML = '';
      uploadedItems.forEach(item => {
        const entry = document.createElement('div');
        const encodedUrl = `/download?file_name=${encodeURIComponent(item.path)}&origin_name=${encodeURIComponent(item.title)}`;
        entry.className = "border p-4 rounded shadow bg-white flex items-center justify-between";
        entry.innerHTML = `
          <span class="font-medium text-gray-800">${item.title}</span>
          <a href="${encodedUrl}" download class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded">
            â¬‡ï¸ ë‹¤ìš´ë¡œë“œ
          </a>
        `;
        downloadList.appendChild(entry);
      });
    }

    sortSelect.addEventListener('change', () => { currentPage = 1; renderUploads(); });
    dateFilter.addEventListener('change', () => { currentPage = 1; renderUploads(); });
    typeFilter.addEventListener('change', () => { currentPage = 1; renderUploads(); });
  </script>
</body>
</html>
